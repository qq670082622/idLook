//
//  HomeMainCellD.m
//  IDLook
//
//  Created by Mr Hu on 2018/9/21.
//  Copyright © 2018年 HYH. All rights reserved.
//

#import "HomeMainCellD.h"
#import "PublicPageControl.h"
#import "TalentModel.h"

@interface HomeMainCellD ()<UIScrollViewDelegate>
@property (nonatomic,strong)UIView *bg;
@property(nonatomic,strong)UIImageView *icon;
@property(nonatomic,strong)UIImageView *auth;

@property(nonatomic,strong)UILabel *name;
@property(nonatomic,strong)UILabel *infoDetial;

@property(nonatomic,strong)UIButton *lookPriceBtn;
@property(nonatomic,strong) UIButton *reginBtn;  //所在地
@property(nonatomic,strong)UILabel *occupationLab; //职业
@property(nonatomic,strong)UserInfoM *info;
@property(nonatomic,strong)UIScrollView *typeView;

@property(nonatomic,strong)UIImageView *videoIcon;
@property(nonatomic,strong)UIButton *timeBtn;

@property(nonatomic,assign)NSInteger cureIndex;
@property(nonatomic,strong)NSMutableArray *showList;
@end

@implementation HomeMainCellD

-(id)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier
{
    if (self=[super initWithStyle:style reuseIdentifier:reuseIdentifier]) {

    }
    return self;
}

-(NSMutableArray*)showList
{
    if (!_showList) {
        _showList=[NSMutableArray new];
    }
    return _showList;
}

-(UIView*)bg
{
    if (!_bg) {
        _bg = [[UIView alloc] init];
        _bg.backgroundColor = [UIColor colorWithRed:255/255.0 green:255/255.0 blue:255/255.0 alpha:1];
//        _bg.layer.shadowColor = [UIColor colorWithRed:55/255.0 green:45/255.0 blue:46/255.0 alpha:0.1].CGColor;
//        _bg.layer.shadowOffset = CGSizeMake(0,10);
//        _bg.layer.shadowOpacity = 1;
//        _bg.layer.shadowRadius = 80;
        _bg.layer.masksToBounds=YES;
        _bg.layer.cornerRadius = 14;
        [self.contentView addSubview:_bg];
        [_bg mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self.contentView).offset(10);
            make.centerX.mas_equalTo(self.contentView);
            make.top.mas_equalTo(self.contentView);
            make.bottom.mas_equalTo(self.contentView).offset(-12);
        }];
    }
    return _bg;
}

-(UIImageView*)icon
{
    if (!_icon) {
        _icon=[[UIImageView alloc]init];
        [self.contentView addSubview:_icon];
//        _icon.userInteractionEnabled=YES;
        _icon.layer.cornerRadius=20;
        _icon.layer.masksToBounds=YES;
        _icon.contentMode=UIViewContentModeScaleAspectFill;
//        UITapGestureRecognizer *tap=[[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(clickUserHead)];
//        [_icon addGestureRecognizer:tap];
        _icon.clipsToBounds=YES;
        [_icon mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self.bg).offset(11);
            make.top.mas_equalTo(self.bg).offset(15);
            make.size.mas_equalTo(CGSizeMake(40, 40));
        }];
    }
    return _icon;
}

-(UIImageView*)auth
{
    if (!_auth) {
        _auth=[[UIImageView alloc]init];
        [self.contentView addSubview:_auth];
        _auth.image=[UIImage imageNamed:@"home_auth"];
        _auth.contentMode=UIViewContentModeScaleAspectFill;
        [_auth mas_makeConstraints:^(MASConstraintMaker *make) {
            make.right.mas_equalTo(self.icon).offset(0);
            make.bottom.mas_equalTo(self.icon).offset(0);
        }];
    }
    return _auth;
}

-(UILabel*)name
{
    if (!_name) {
        _name=[[UILabel alloc]init];
        _name.font=[UIFont boldSystemFontOfSize:14.0];
        _name.textColor=Public_Text_Color;
        [self.contentView addSubview:_name];
        [_name mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self.icon.mas_right).offset(10);
            make.top.mas_equalTo(self.bg).offset(20);
        }];
    }
    return _name;
}

-(UILabel*)infoDetial
{
    if (!_infoDetial) {
        _infoDetial=[[UILabel alloc]init];
        _infoDetial.font=[UIFont systemFontOfSize:11.0];
        _infoDetial.text=@"个人详情 >";
        _infoDetial.textColor=[UIColor colorWithHexString:@"#ff7e4e"];
        [self.contentView addSubview:_infoDetial];
        [_infoDetial mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self.icon.mas_right).offset(10);
            make.bottom.mas_equalTo(self.icon).offset(0);
        }];
    }
    return _infoDetial;
}

-(UIButton*)lookPriceBtn
{
    if (!_lookPriceBtn) {
        _lookPriceBtn=[UIButton buttonWithType:UIButtonTypeCustom];
        [self.contentView addSubview:_lookPriceBtn];
//        _lookPriceBtn.backgroundColor=Public_Red_Color;
        _lookPriceBtn.layer.masksToBounds=YES;
        _lookPriceBtn.layer.cornerRadius=12.0;
        _lookPriceBtn.layer.borderColor=[UIColor colorWithHexString:@"#EBEBEB"].CGColor;
        _lookPriceBtn.layer.borderWidth=1.0;
        [_lookPriceBtn setTitleColor:Public_Red_Color forState:UIControlStateNormal];
        _lookPriceBtn.titleLabel.font=[UIFont systemFontOfSize:11.0];
        _lookPriceBtn.imageEdgeInsets=UIEdgeInsetsMake(0,-3,0,3);
        [_lookPriceBtn setTitle:@"查看报价" forState:UIControlStateNormal];
        [_lookPriceBtn mas_makeConstraints:^(MASConstraintMaker *make) {
            make.centerY.mas_equalTo(self.icon);
            make.right.mas_equalTo(self.contentView).offset(-22);
            make.size.mas_equalTo(CGSizeMake(80, 24));
        }];
        [_lookPriceBtn addTarget:self action:@selector(lookUserOfferAction) forControlEvents:UIControlEventTouchUpInside];
        
        if ([UserInfoManager getUserLoginType]==UserLoginTypeTourist || [UserInfoManager getUserAuthState]!=1) {
            [_lookPriceBtn setImage:[UIImage imageNamed:@"home_lock"] forState:UIControlStateNormal];
            _lookPriceBtn.titleEdgeInsets=UIEdgeInsetsMake(0, 3, 0, -3);
        }
        else
        {
            [_lookPriceBtn setImage:[UIImage imageNamed:@""] forState:UIControlStateNormal];
        }
    }
    return _lookPriceBtn;
}

-(UIButton*)reginBtn
{
    if (!_reginBtn) {
        _reginBtn=[UIButton buttonWithType:UIButtonTypeCustom];
        [self.contentView addSubview:_reginBtn];
        [_reginBtn setTitleColor:[UIColor colorWithHexString:@"#CCCCCC"] forState:UIControlStateNormal];
        _reginBtn.titleLabel.font=[UIFont systemFontOfSize:11.0];
        [_reginBtn setImage:[UIImage imageNamed:@"home_postion_gray"] forState:UIControlStateNormal];
        [_reginBtn setImage:[UIImage imageNamed:@"home_postion_gray"] forState:UIControlStateHighlighted];
        [_reginBtn mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self.occupationLab.mas_right).offset(10);
            make.centerY.mas_equalTo(self.name);
        }];
        _reginBtn.enabled=NO;
    }
    return _reginBtn;
}

-(UILabel*)occupationLab
{
    if (!_occupationLab) {
        _occupationLab=[[UILabel alloc]init];
        [self.contentView addSubview:_occupationLab];
        _occupationLab.layer.masksToBounds=YES;
        _occupationLab.layer.cornerRadius=9.0;
        _occupationLab.textAlignment=NSTextAlignmentCenter;
        _occupationLab.backgroundColor=[[UIColor colorWithHexString:@"#FF2C54"]colorWithAlphaComponent:0.1];
        _occupationLab.textColor =[UIColor colorWithHexString:@"#FF2C54"];
        _occupationLab.font=[UIFont systemFontOfSize:11.0];
        [_occupationLab mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self.name.mas_right).offset(5);
            make.centerY.mas_equalTo(self.name);
            make.size.mas_equalTo(CGSizeMake(61, 18));
        }];
    }
    return _occupationLab;
}

-(UIScrollView*)typeView
{
    if (!_typeView) {
        _typeView=[[UIScrollView alloc]init];
//        _typeView.userInteractionEnabled=YES;
        _typeView.showsVerticalScrollIndicator=NO;
        _typeView.showsHorizontalScrollIndicator=NO;
        [self.contentView addSubview:_typeView];
        [_typeView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self.bg);
            make.right.mas_equalTo(self.bg);
            make.bottom.mas_equalTo(self.videoIcon.mas_top);
            make.top.mas_equalTo(self.icon.mas_bottom);
        }];
    }
    return _typeView;
}

-(UIImageView*)videoIcon
{
    if (!_videoIcon) {
        _videoIcon=[[UIImageView alloc]init];
        [self.contentView addSubview:_videoIcon];
        _videoIcon.userInteractionEnabled=YES;
        _videoIcon.contentMode=UIViewContentModeScaleAspectFill;
        _videoIcon.clipsToBounds=YES;
        _videoIcon.layer.masksToBounds=YES;
        _videoIcon.layer.cornerRadius=5.0;
        [_videoIcon mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self.contentView).offset(22);
            make.centerX.mas_equalTo(self.contentView);
            make.top.mas_equalTo(self.contentView).offset(108);
            make.bottom.mas_equalTo(self.bg).offset(-15);
        }];
        UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(clickVideoTap)];
        [_videoIcon addGestureRecognizer:tap];
    }
    return _videoIcon;
}


-(UIButton*)timeBtn
{
    if (!_timeBtn) {
        _timeBtn=[UIButton buttonWithType:UIButtonTypeCustom];
        [self.contentView addSubview:_timeBtn];
        _timeBtn.layer.masksToBounds=YES;
        _timeBtn.layer.cornerRadius=9;
        _timeBtn.backgroundColor=[[UIColor colorWithHexString:@"#000000"]colorWithAlphaComponent:0.5];
        _timeBtn.titleLabel.font=[UIFont systemFontOfSize:10.0];
        [_timeBtn setTitle:@"00:00" forState:UIControlStateNormal];
        [_timeBtn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
        [_timeBtn setImage:[UIImage imageNamed:@"u_video_s"] forState:UIControlStateNormal];
        [_timeBtn mas_makeConstraints:^(MASConstraintMaker *make) {
            make.right.mas_equalTo(self.videoIcon.mas_right).offset(-10);
            make.bottom.mas_equalTo(self.videoIcon).offset(-10);
            make.size.mas_equalTo(CGSizeMake(54, 18));
        }];
        _timeBtn.titleEdgeInsets=UIEdgeInsetsMake(0,2, 0, -2);
    }
    return _timeBtn;
}


-(void)reloadUIWithModel:(UserInfoM *)model withSelect:(NSString*)select
{
    self.cureIndex=0;
    self.info=model;
    self.showList = [NSMutableArray arrayWithArray:self.info.showlist];
    
    //将值放到第一个
    for (int i=0; i<self.showList.count; i++) {
        NSDictionary *dic = self.showList[i];
        if ([dic[@"catename"] isEqualToString:select]) {
            [self.showList removeObjectAtIndex:i];
            [self.showList insertObject:dic atIndex:0];
            break;
        }
    }
    
    self.info.showlist = self.showList;
    
    [self bg];
    [self.icon sd_setImageWithUrlStr:model.head placeholderImage:[UIImage imageNamed:@"default_home"]];
    [self infoDetial];
    
    if ([UserInfoManager getUserType]==UserTypeResourcer)
    {
        self.lookPriceBtn.hidden=YES;
    }
    else
    {
        self.lookPriceBtn.hidden=NO;
    }
    
    self.reginBtn.hidden=model.region.length>0?NO:YES;
    [self.reginBtn setTitle:model.region forState:UIControlStateNormal];
    
    self.occupationLab.hidden=model.occupation>0?NO:YES;
    NSArray *array1 = [[UserInfoManager getPublicConfig] objectForKey:@"occupationType"];
    for (int i=0; i<array1.count; i++) {
        NSDictionary *dic = array1[i];
        if (model.occupation == [dic[@"attrid"] integerValue]) {
            self.occupationLab.text = dic[@"attrname"];
        }
    }
    
    
    NSString *sex = @"";
    if (model.sex==1) {
        sex=@"/男";
    }
    else if (model.sex==2)
    {
        sex=@"/女";
    }
    else
    {
        sex=@"  ";
    }
    
    NSString *str=[NSString stringWithFormat:@"%@%@",model.nick.length>0?model.nick:model.name,sex];
    NSMutableAttributedString * attStr = [[NSMutableAttributedString alloc] initWithString:str];
    [attStr addAttributes:@{NSForegroundColorAttributeName:[UIColor colorWithHexString:@"#999999"],NSFontAttributeName:[UIFont systemFontOfSize:12.0]} range:NSMakeRange(str.length-2,2)];
    self.name.attributedText=attStr;
    
    for (UIView *view in self.typeView.subviews) {
        [view removeFromSuperview];
    }
    
//    if (model.creative.count==0) {
//        return;
//    }
    
    self.videoIcon.image=[UIImage imageNamed:@"default_video"];
    [self.timeBtn setTitle:@"00:00" forState:UIControlStateNormal];

    self.typeView.contentSize=CGSizeMake(88*self.showList.count+12, 0);
    self.typeView.contentOffset=CGPointMake(0, 0);

    UIImage *image = [UIImage imageNamed:@"home_type_n"];
    for (int i =0; i<self.showList.count;i++) {
        UIButton *btn=[UIButton buttonWithType:UIButtonTypeCustom];
        [self.typeView addSubview:btn];
        btn.tag=1000+i;
        btn.frame=CGRectMake(12+image.size.width*i,0,image.size.width,image.size.height);
        [btn setTitleColor:[UIColor colorWithHexString:@"#999999"] forState:UIControlStateNormal];
        [btn setTitleColor:[UIColor whiteColor] forState:UIControlStateSelected];
        btn.titleLabel.font=[UIFont systemFontOfSize:12.0];
        [btn setBackgroundImage:[UIImage imageNamed:@"home_type_n"] forState:UIControlStateNormal];
        [btn setBackgroundImage:[UIImage imageNamed:@"home_type_h"] forState:UIControlStateSelected];

        [btn setTitle:self.showList[i][@"catename"] forState:UIControlStateNormal];
        if (i==0) {
            btn.selected=YES;
            NSDictionary *dicA = [self getVideoImageWithIndex:0];
            [self.videoIcon sd_setImageWithUrlStr:dicA[@"cutVideourl"] placeholderImage:[UIImage imageNamed:@"default_video"]];
            [self.timeBtn setTitle:dicA[@"timevideo"] forState:UIControlStateNormal];
            self.typeContent = btn.titleLabel.text;
        }
        [btn addTarget:self action:@selector(typeClick:) forControlEvents:UIControlEventTouchUpInside];
    }

}

//查看用户主页
-(void)clickUserHead
{
    if (self.clickUserInfo) {
        self.clickUserInfo();
    }
}

//查看报价
-(void)lookUserOfferAction
{
    if (self.lookUserOffer) {
        self.lookUserOffer();
    }
}

//播放视频
-(void)clickVideoTap
{
    if (self.showList.count==0) {
        return;
    }
    
    NSDictionary *dic = [self getVideoImageWithIndex:self.cureIndex];
    if (self.playVideWithUrl) {
        self.playVideWithUrl(dic[@"url"]);
    }
}

-(void)typeClick:(UIButton*)sender
{
    self.typeContent = sender.titleLabel.text;
    self.cureIndex=sender.tag-1000;
    for (int i =0; i<self.showList.count; i++) {
        UIButton *btn = [self.typeView viewWithTag:1000+i];
        if (i==sender.tag-1000) {
            btn.selected=YES;
        }
        else
        {
            btn.selected=NO;
        }
    }
    NSDictionary *dic = [self getVideoImageWithIndex:self.cureIndex];
    
    [self.videoIcon sd_setImageWithUrlStr:dic[@"cutVideourl"] placeholderImage:[UIImage imageNamed:@"default_video"]];
    [self.timeBtn setTitle:dic[@"timevideo"] forState:UIControlStateNormal];
    
//    if (self.endDeceleratingBlock) {
//        self.endDeceleratingBlock();
//    }
    
    if (self.playVideWithUrl) {
        self.playVideWithUrl(dic[@"url"]);
    }
}

//等到showlist数据
-(NSDictionary*)getVideoImageWithIndex:(NSInteger)index
{
    NSDictionary *list = self.showList[index][@"lists"];
    NSArray *talent = (NSArray*)safeObjectForKey(list, @"talent");
    NSArray *pastwork = (NSArray*)safeObjectForKey(list, @"pastwork");
    NSArray *modelcard = (NSArray*)safeObjectForKey(list, @"modelcard");
    
    NSString *cutVideourl;
    NSString *timevideo;
    NSString *url;
    if (talent.count>0) {
        TalentModel *model = [[TalentModel alloc]initTalentDic:[talent firstObject]];
        cutVideourl=model.cutvideo;
        timevideo = model.timevideo;
        url = model.video;
    }
    else if (pastwork.count>0)
    {
        WorksModel *model = [[WorksModel alloc]initWithPastWorkDic:[pastwork firstObject]];
        cutVideourl =model.cutvideo;
        timevideo = model.timevideo;
        url = model.url;
    }
    else if (modelcard.count>0)
    {
        TalentModel *model = [[TalentModel alloc]initModelCardDic:[modelcard firstObject]];
        cutVideourl =model.cutvideo;
        timevideo = model.timevideo;
        url = model.video;
    }
    
    [self.videoIcon sd_setImageWithUrlStr:cutVideourl placeholderImage:[UIImage imageNamed:@"default_video"]];
    [self.timeBtn setTitle:timevideo forState:UIControlStateNormal];
    
    return @{@"cutVideourl":cutVideourl,@"timevideo":timevideo,@"url":url};
}


@end
