//
//  PerformModel.m
//  IDLook
//
//  Created by Mr Hu on 2018/9/21.
//  Copyright © 2018年 HYH. All rights reserved.
//

#import "PerformModel.h"
#import "TalentModel.h"

@implementation PerformModel

-(id)init
{
    if (self=[super init]) {
        
    }
    return self;
}

- (NSMutableArray *)ds
{
    if(!_ds)
    {
        _ds = [[NSMutableArray alloc]initWithObjects:@[],@[], nil];
    }
    return _ds;
}

- (NSMutableArray *)selectDatasource
{
    if(!_selectDatasource)
    {
        _selectDatasource = [NSMutableArray new];
    }
    return _selectDatasource;
}

-(void)refreshWorksInfo
{
    
    [SVProgressHUD showWithMaskType:SVProgressHUDMaskTypeClear];
    NSDictionary *dicArg=@{@"userid":[UserInfoManager getUserUID],
                           @"type":@"1,4"
                           };
    
    [AFWebAPI getWorksModelcardMirrorList:dicArg callBack:^(BOOL success, id object) {
        if (success) {
            [SVProgressHUD dismiss];
            
            [self analyzeDataWithDic:[object objectForKey:JSON_data]];
        }
        else
        {
            AF_SHOW_RESULT_ERROR
        }
    }];
    
}

-(void)analyzeDataWithDic:(NSDictionary*)dic
{
    [self.ds removeAllObjects];
    
    NSMutableArray *sec0 = [NSMutableArray new];
    NSMutableArray *sec1 = [NSMutableArray new];
    
    {
        NSArray *worksList = dic[@"talentshow"];   //表演类型
        for (int i=0; i<worksList.count; i++) {
            NSDictionary *dic = worksList[i];
            NSArray *array = dic[@"list"];
            NSMutableArray *Arr = [[NSMutableArray alloc]initWithCapacity:0];
            for (int j=0; j<array.count; j++) {
                WorksModel *model = [[WorksModel alloc]initWithWorksDic:array[j]];
                [Arr addObject:model];
            }
            [sec0 addObject:Arr];
        }
    }
    
    {
        NSArray *array = dic[@"modelcard"];
        for (int i =0 ; i<array.count; i++) {
            NSMutableArray *dataS = [NSMutableArray new];
            TalentModel *model1 = [[TalentModel alloc]initModelCardDic:array[i]];
            model1.isModelCard=1;
            TalentModel *model2 = [[TalentModel alloc]initModelCardDic:array[i]];
            
            [dataS addObject:model1];
            [dataS addObject:model2];
            
            [sec1 addObject:@{@"name":model1.type,
                                    @"list":dataS}];
        }
    }
    
    [self.ds addObject:sec0];
    [self.ds addObject:sec1];
    if (self.refreshUIAction) {
        self.refreshUIAction(YES);
    }
}


//删除作品或者微出镜，试葩间
-(void)delectTalent
{
    //遍历得到id数组
    NSArray *array = self.selectDatasource;
    NSMutableArray *idArr = [[NSMutableArray alloc]initWithCapacity:0];
    for (int i = 0; i<array.count; i++) {
        WorksModel *model =array[i];
        [idArr addObject:model.creativeid];
    }
    NSString *idStr = [idArr componentsJoinedByString:@","];
    
    NSDictionary *dicArg = @{@"userid":[UserInfoManager getUserUID],
                             @"creativeid":idStr,
                             @"type":@(1)
                             };
    [AFWebAPI setDelectWroks:dicArg callBack:^(BOOL success, id object) {
        if (success) {
            [SVProgressHUD showSuccessWithStatus:@"删除成功"];
            
            NSDictionary *dic = (NSDictionary*)safeObjectForKey(object, JSON_data);
            [self analyzeDelectDataWithDic:dic withType:0];
        }
        else
        {
            AF_SHOW_RESULT_ERROR
        }
    }];
}

-(void)analyzeDelectDataWithDic:(NSDictionary*)dic withType:(NSInteger)type
{
    NSMutableArray *dataS = [[NSMutableArray alloc]initWithCapacity:0];
    if (type==0) {
        NSArray *worksList=(NSArray*)safeObjectForKey(dic, @"talentshow");
        for (int i=0; i<worksList.count; i++) {
            NSDictionary *dic = worksList[i];
            NSArray *array = dic[@"list"];
            NSMutableArray *Arr = [[NSMutableArray alloc]initWithCapacity:0];
            for (int j=0; j<array.count; j++) {
                WorksModel *model = [[WorksModel alloc]initWithWorksDic:array[j]];
                [Arr addObject:model];
            }
            [dataS addObject:Arr];
        }
    }
    else if (type==1)
    {
        NSArray *array = dic[@"modelcard"];
        for (int i =0 ; i<array.count; i++) {
            NSMutableArray *dataSource = [NSMutableArray new];
            TalentModel *model1 = [[TalentModel alloc]initModelCardDic:array[i]];
            model1.isModelCard=1;
            TalentModel *model2 = [[TalentModel alloc]initModelCardDic:array[i]];
            
            [dataSource addObject:model1];
            [dataSource addObject:model2];
            
            [dataS addObject:@{@"name":model1.type,
                              @"list":dataSource}];
        }
    }
    
    [self.ds replaceObjectAtIndex:type withObject:dataS];
    if (self.refreshUIAction) {
        self.refreshUIAction(NO);
    }
}


//编辑状态
-(void)getEditStateWithEdit:(BOOL)edit
{
    NSMutableArray *array = [[NSMutableArray alloc]initWithArray:self.ds[0]];
    for (int i = 0 ; i<array.count; i++) {
        NSMutableArray *arr= [[NSMutableArray alloc]initWithArray:array[i]];
        for (int j =0; j<arr.count; j++) {
            WorksModel *model = (WorksModel*)arr[j];
            model.isEdit=edit;
        };
    }
}

//全选,取消
-(void)allChooseWithSelect:(BOOL)select
{
    [self.selectDatasource removeAllObjects];
    NSMutableArray *array = [[NSMutableArray alloc]initWithArray:self.ds[0]];
    for (int i = 0 ; i<array.count; i++)
    {
        NSMutableArray *arr= [[NSMutableArray alloc]initWithArray:array[i]];
        for (int j =0; j<arr.count; j++) {
            WorksModel *model = (WorksModel*)arr[j];
            model.isSelect=select;
            if (select) {
                [self.selectDatasource addObject:model];
            }
        }
    }
}

//改变一条数据
-(void)changeoneDataWithIndaxPath:(NSIndexPath *)indexPath withSelect:(BOOL)select
{
    NSMutableArray *array = [[NSMutableArray alloc]initWithArray:self.ds[0]];
    NSMutableArray *arr= [[NSMutableArray alloc]initWithArray:array[indexPath.section]];
    WorksModel *model = (WorksModel*)arr[indexPath.row];
    model.isSelect=select;
    if (select) {
        [self.selectDatasource addObject:model];
    }
    else
    {
        if ([self.selectDatasource containsObject:model]) {
            [self.selectDatasource removeObject:model];
        }
    }
}

//是否全选中
-(BOOL)isAllChoose
{
    NSMutableArray *array = [[NSMutableArray alloc]initWithArray:self.ds[0]];
    for (int i = 0 ; i<array.count; i++) {
        NSMutableArray *arr= [[NSMutableArray alloc]initWithArray:array[i]];
        for (int j =0; j<arr.count; j++) {
            WorksModel *model = (WorksModel*)arr[j];
            if (model.isSelect==NO) {
                return NO;
            }
        }
    }
    return YES;
}

//删除模特卡
-(void)delectModelCardWithIndex:(NSInteger)index
{
    NSMutableArray *array = [[NSMutableArray alloc]initWithArray:self.ds[1]];
    NSDictionary *dic = array[index];
    NSArray *list = dic[@"list"];
    TalentModel *model = [list firstObject];
    
    NSDictionary *dicArg = @{@"userid":[UserInfoManager getUserUID],
                             @"creativeid":model.creativeid,
                             @"type":@(3)
                             };
    [AFWebAPI setDelectWroks:dicArg callBack:^(BOOL success, id object) {
        if (success) {
            [SVProgressHUD showSuccessWithStatus:@"删除成功"];
            
            NSDictionary *dic = (NSDictionary*)safeObjectForKey(object, JSON_data);
            [self analyzeDelectDataWithDic:dic withType:1];
        }
        else
        {
            AF_SHOW_RESULT_ERROR
        }
    }];
}

@end
