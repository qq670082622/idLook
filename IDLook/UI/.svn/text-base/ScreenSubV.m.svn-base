//
//  ScreenSubV.m
//  IDLook
//
//  Created by HYH on 2018/6/12.
//  Copyright © 2018年 HYH. All rights reserved.
//

#import "ScreenSubV.h"

@interface ScreenSubV ()
@property(nonatomic,strong)UILabel *titleLab;
@property(nonatomic,strong)NSArray *dataS;
@property(nonatomic,assign)NSInteger type;
@end

@implementation ScreenSubV

-(NSMutableArray*)selectArray
{
    if (!_selectArray) {
        _selectArray=[[NSMutableArray alloc]initWithCapacity:0];
    }
    return _selectArray;
}

-(UILabel*)titleLab
{
    if (!_titleLab) {
        _titleLab=[[UILabel alloc]init];
        [self addSubview:_titleLab];
        _titleLab.font=[UIFont boldSystemFontOfSize:14.0];
        _titleLab.textColor=Public_Text_Color;
        [_titleLab mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self).offset(15);
            make.top.mas_equalTo(self).offset(10);
        }];
        
    }
    return _titleLab;
}

-(void)reloadUIWithDic:(NSDictionary *)dic withSelect:(NSString *)select
{
    NSString *title = [dic objectForKey:kScreenPopVCMCellTitle];
    NSArray *array = [dic objectForKey:kScreenPopVCMCellData];
    NSInteger type = [[dic objectForKey:kScreenPopVCMCellType] integerValue];
    
    self.titleLab.text = title;
    self.dataS=array;
    self.type=type;
    
    if (type!=ScreenCellTypeAdv)
    {
        if (type==ScreenCellTypeAge || type==ScreenCellTypePrice) {
            NSArray *selectArr = [select componentsSeparatedByString:@","];
            for (int i =0; i<selectArr.count; i++) {
                NSInteger index = [selectArr[i] integerValue];
                if (index!=0) {
                    [self.selectArray addObject:@(index)];
                }
            }
        }
        else if (type==ScreenCellTypeCity)
        {
            if (select.length) {
                [self.selectArray addObject:select];
            }
        }
        
        [self initPart1];
    }
    else
    {
        NSArray *selectArr = [select componentsSeparatedByString:@","];
        
        for (int i =0; i<selectArr.count; i++) {
            NSInteger index = [selectArr[i] integerValue];            
            if (index!=0) {
                [self.selectArray addObject:@(index)];
            }
        }
        
        [self initParrt2];
    }
}

//除广告类型外，其他类型加载这个视图
-(void)initPart1
{
    for (UIView *view in self.subviews) {
        if (view.tag>=100) {
            [view removeFromSuperview];
        }
    }
    
    CGFloat width = 0.f;
    NSInteger count = 0;
    if (self.type==ScreenCellTypePrice) {
        width = (UI_SCREEN_WIDTH*0.8 - 30 -10)/2;
        count = 2 ;
    }
    else
    {
        width = (UI_SCREEN_WIDTH*0.8-30-10*2)/3;
        count=3;
    }
    for (int i =0; i<self.dataS.count; i++) {
        NSDictionary *dic = self.dataS[i];
        UIButton *button=[[UIButton alloc]init];
        [self addSubview:button];
        button.layer.cornerRadius=3.0;
        button.layer.borderColor=[UIColor colorWithHexString:@"#F5F5F5"].CGColor;
        button.layer.borderWidth=0.5;
        button.tag=1000+i;
        button.titleLabel.font=[UIFont systemFontOfSize:13.0];
        [button setTitleColor:[UIColor colorWithHexString:@"#666666"] forState:UIControlStateNormal];
        [button setTitleColor:Public_Red_Color forState:UIControlStateSelected];
        [button setBackgroundColor:[UIColor colorWithHexString:@"#F5F5F5"]];
        [button setTitle:dic[@"attrname"] forState:UIControlStateNormal];
        [button mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self).offset(15+(width+12)*(i%count));
            make.top.mas_equalTo(self).offset(40+(i/count)*44);
            make.size.mas_equalTo(CGSizeMake(width, 32));
        }];
        [button addTarget:self action:@selector(clickType:) forControlEvents:UIControlEventTouchUpInside];
        
        if (self.type==ScreenCellTypeAge || self.type==ScreenCellTypePrice) {
            if ([self.selectArray containsObject:dic[@"attrid"]]) {
                [button setBackgroundColor:[Public_Red_Color colorWithAlphaComponent:0.1]];
                button.layer.borderColor=Public_Red_Color.CGColor;
                button.selected=YES;
            }
        }
        else if (self.type==ScreenCellTypeCity)
        {
            if ([self.selectArray containsObject:dic[@"attrname"]]) {
                [button setBackgroundColor:[Public_Red_Color colorWithAlphaComponent:0.1]];
                button.layer.borderColor=Public_Red_Color.CGColor;
                button.selected=YES;
            }
        }
    }
}

-(void)clickType:(UIButton*)sender
{
    //单选
    if (self.type==ScreenCellTypeCity) {
        for (int i = 0; i<self.dataS.count; i++) {
            UIButton * button = (UIButton*)[self viewWithTag:1000+i];
            if (i==sender.tag-1000) {
                [button setBackgroundColor:[Public_Red_Color colorWithAlphaComponent:0.1]];
                button.layer.borderColor=Public_Red_Color.CGColor;
                button.selected=YES;
            }
            else
            {
                [button setBackgroundColor:[UIColor colorWithHexString:@"#F5F5F5"]];
                button.layer.borderColor=[UIColor colorWithHexString:@"#F5F5F5"].CGColor;
                button.selected=NO;

            }
        }
        [self.selectArray removeAllObjects];
        if (sender.selected) {
            [self.selectArray addObject:sender.titleLabel.text];
        }
    }
    else     //多选
    {
        sender.selected=!sender.selected;
        if (sender.selected==YES) {
            sender.layer.borderColor=Public_Red_Color.CGColor;
            [sender setBackgroundColor:[Public_Red_Color colorWithAlphaComponent:0.1]];
            
            if (![self.selectArray containsObject:@(sender.tag-1000+1)]) {
                [self.selectArray addObject:@(sender.tag-1000+1)];
            }
        }
        else
        {
            [sender setBackgroundColor:[UIColor colorWithHexString:@"#F5F5F5"]];
            sender.layer.borderColor=[UIColor colorWithHexString:@"#F5F5F5"].CGColor;
            
            if ([self.selectArray containsObject:@(sender.tag-1000+1)]) {
                [self.selectArray removeObject:@(sender.tag-1000+1)];
            }
        }
    }
}

//广告类型加载这个视图
-(void)initParrt2
{
    for (UIView *view in self.subviews) {
        if (view.tag>=100) {
            [view removeFromSuperview];
        }
    }
    
    CGFloat width = (UI_SCREEN_WIDTH*0.8 - 30 -10)/2;
    CGFloat Vheight = 0;
    
    for (int i =0; i<self.dataS.count; i++) {
        NSArray *array = self.dataS[i][@"data"];
        UIView *view = [[UIView alloc]init];
//        view.backgroundColor=[UIColor redColor];
        [self addSubview:view];
        CGFloat height = ((array.count-1)/2+1)*44 + 30;
        [view mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(self);
            make.right.mas_equalTo(self);
            make.top.mas_equalTo(self).offset(Vheight+30);
            make.height.mas_equalTo(height);
        }];
        
        Vheight = Vheight + height;

        UILabel *title=[[UILabel alloc]init];
        [view addSubview:title];
        title.font=[UIFont systemFontOfSize:13.0];
        title.textColor=Public_Text_Color;
        title.text=self.dataS[i][@"title"];
        [title mas_makeConstraints:^(MASConstraintMaker *make) {
            make.centerX.mas_equalTo(self);
            make.top.mas_equalTo(view).offset(10);
        }];

        for (int j =0; j<array.count; j++) {
            NSDictionary *dic = array[j];
            UIButton *button=[[UIButton alloc]init];
            [self addSubview:button];
            button.layer.cornerRadius=3.0;
            button.layer.borderColor=[UIColor colorWithHexString:@"#F5F5F5"].CGColor;
            button.layer.borderWidth=0.5;
            button.tag=1000+[dic[@"attrid"]integerValue];
            button.titleLabel.font=[UIFont systemFontOfSize:13.0];
            [button setTitleColor:[UIColor colorWithHexString:@"#666666"] forState:UIControlStateNormal];
            [button setTitleColor:Public_Red_Color forState:UIControlStateSelected];
            [button setBackgroundColor:[UIColor colorWithHexString:@"#F5F5F5"]];
            [button setTitle:dic[@"attrname"] forState:UIControlStateNormal];
            [button mas_makeConstraints:^(MASConstraintMaker *make) {
                make.left.mas_equalTo(self).offset(15+(width+10)*(j%2));
                make.top.mas_equalTo(title.mas_bottom).offset(10+(j/2)*44);
                make.size.mas_equalTo(CGSizeMake(width, 32));
            }];
            [button addTarget:self action:@selector(clickType3:) forControlEvents:UIControlEventTouchUpInside];
            
            if ([self.selectArray containsObject:dic[@"attrid"]]) {
                [button setBackgroundColor:[Public_Red_Color colorWithAlphaComponent:0.1]];
                button.layer.borderColor=Public_Red_Color.CGColor;
                button.selected=YES;
            }
        }
    }
}

-(void)clickType3:(UIButton*)sender
{
    //多选
    sender.selected=!sender.selected;
    if (sender.selected==YES) {
        sender.layer.borderColor=Public_Red_Color.CGColor;
        [sender setBackgroundColor:[Public_Red_Color colorWithAlphaComponent:0.1]];
    }
    else
    {
        [sender setBackgroundColor:[UIColor colorWithHexString:@"#F5F5F5"]];
        sender.layer.borderColor=[UIColor colorWithHexString:@"#F5F5F5"].CGColor;
    }
    
    if (sender.selected) {
        if (![self.selectArray containsObject:@(sender.tag-1000)]) {
            [self.selectArray addObject:@(sender.tag-1000)];
        }
    }
    else
    {
        if ([self.selectArray containsObject:@(sender.tag-1000)]) {
            [self.selectArray removeObject:@(sender.tag-1000)];
        }
    }

}


-(void)allcCancleSelect
{
    for (id obj in self.subviews) {
        if ([obj isKindOfClass:[UIButton class]]) {
            UIButton *btn = (UIButton*)obj;
            btn.selected=NO;
            [btn setBackgroundColor:[UIColor colorWithHexString:@"#F5F5F5"]];
            btn.layer.borderColor=[UIColor colorWithHexString:@"#F5F5F5"].CGColor;
        }
    }
    [self.selectArray removeAllObjects];
}

@end
