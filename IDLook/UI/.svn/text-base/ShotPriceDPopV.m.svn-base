//
//  ShotPriceDPopV.m
//  IDLook
//
//  Created by Mr Hu on 2018/10/17.
//  Copyright © 2018年 HYH. All rights reserved.
//

#import "ShotPriceDPopV.h"

@interface ShotPriceDPopV ()
@property (nonatomic,strong)UIView *maskV;
@end

@implementation ShotPriceDPopV
- (id)init
{
    if(self=[super init])
    {
        
    }
    return self;
}

- (void)showWithLoad:(BOOL)isLoading withModel:(OrderStructM *)model withTotal:(NSString *)total withType:(NSInteger)type withSale:(NSInteger)sale
{
    UIWindow *showWindow = nil;
    NSEnumerator *frontToBackWindows = [[[UIApplication sharedApplication]windows]reverseObjectEnumerator];
    
    for (UIWindow *window in frontToBackWindows)
    {
        if (window.windowLevel == UIWindowLevelNormal)
        {
            showWindow = window;
            break;
        }
    }
    if(!showWindow)return;
    
    //当window上有视图时移除
    for (UIView *view in showWindow.subviews) {
        if ([view isKindOfClass:[ShotPriceDPopV class]]) {
            ShotPriceDPopV *popV = (ShotPriceDPopV*)view;
            [popV hide];
            return;
        }
    }
    
    if (isLoading==NO) {
        return;
    }
    
    self.frame=CGRectMake(0, 0, showWindow.bounds.size.width, showWindow.bounds.size.height-60);
    self.backgroundColor = [[UIColor blackColor] colorWithAlphaComponent:.5f];
    
    UIView *maskV = [[UIView alloc] initWithFrame:CGRectMake(0, UI_SCREEN_HEIGHT-60,UI_SCREEN_WIDTH, 240)];
    maskV.backgroundColor = [UIColor whiteColor];
    maskV.alpha = 0.f;
    maskV.layer.borderColor=Public_LineGray_Color.CGColor;
    maskV.layer.borderWidth=0.5;
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(hide)];
    tap.numberOfTapsRequired = 1;
    [self addGestureRecognizer:tap];
    [showWindow addSubview:self];
    [self addSubview:maskV];
    self.clipsToBounds=YES;
    self.maskV=maskV;
    
    [self initUIWIthModel:model total:total withType:type withSale:sale];
    
    [UIView beginAnimations:nil context:NULL];
    [UIView setAnimationDuration:.25];
    [UIView setAnimationCurve:7];
    
    maskV.alpha = 1.f;
    
    self.maskV.frame = CGRectMake(0, UI_SCREEN_HEIGHT-240-60, UI_SCREEN_WIDTH,240);
    [UIView commitAnimations];
}


- (void)clearSubV
{
    [self removeFromSuperview];
    [self.maskV removeFromSuperview];
}
- (void)hide
{
    //    [self clearSubV];
    
    [UIView beginAnimations:nil context:NULL];
    [UIView setAnimationDuration:.25];
    [UIView setAnimationCurve:7];
    
    [UIView setAnimationDelegate:self];
    [UIView setAnimationDidStopSelector:@selector(clearSubV)];
    self.alpha = 0.f;
    
    self.maskV.frame = CGRectMake(0, UI_SCREEN_HEIGHT, UI_SCREEN_WIDTH, 240);
    
    [UIView commitAnimations];
}

-(void)initUIWIthModel:(OrderStructM*)model total:(NSString*)total withType:(NSInteger)type withSale:(NSInteger)sale
{
    UILabel *title = [[UILabel alloc] init];
    title.font = [UIFont systemFontOfSize:14.0];
    title.textColor = Public_Text_Color;
    [self.maskV addSubview:title];
    [title mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.maskV).offset(15);
        make.top.mas_equalTo(self.maskV).offset(14);
    }];
    title.text=@"价格明细";
    
    UIButton *cancleBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    [cancleBtn setImage:[UIImage imageNamed:@"price_detail_close"] forState:UIControlStateNormal];
    [cancleBtn addTarget:self action:@selector(hide) forControlEvents:UIControlEventTouchUpInside];
    [self.maskV addSubview:cancleBtn];
    [cancleBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(self.maskV).offset(0);
        make.right.equalTo(self.maskV).offset(0);
        make.size.mas_equalTo(CGSizeMake(40, 40));
    }];
    
    UIView *lineV1=[[UIView alloc]init];
    lineV1.backgroundColor=[UIColor colorWithHexString:@"#F7F7F7"];
    [self.maskV addSubview:lineV1];
    [lineV1 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.maskV);
        make.right.mas_equalTo(self.maskV);
        make.top.mas_equalTo(self.maskV).offset(40);
        make.height.mas_equalTo(0.5);
    }];
    
    UILabel *titleLab1 = [[UILabel alloc] init];
    titleLab1.font = [UIFont systemFontOfSize:14.0];
    titleLab1.textColor = Public_Text_Color;
    [self.maskV addSubview:titleLab1];
    [titleLab1 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.maskV).offset(15);
        make.top.mas_equalTo(lineV1.mas_bottom).offset(21);
    }];
    titleLab1.text=model.content;
    
    UILabel *priceLab1 = [[UILabel alloc] init];
    priceLab1.font = [UIFont systemFontOfSize:14.0];
    priceLab1.textColor = Public_Red_Color;
    [self.maskV addSubview:priceLab1];
    [priceLab1 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_equalTo(self.maskV).offset(-15);
        make.centerY.mas_equalTo(titleLab1);
    }];
    priceLab1.text=[NSString stringWithFormat:@"¥%@",model.price];
    
    
    UIView *lineV2=[[UIView alloc]init];
    lineV2.backgroundColor=[UIColor colorWithHexString:@"#F7F7F7"];
    [self.maskV addSubview:lineV2];
    [lineV2 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.maskV);
        make.right.mas_equalTo(self.maskV);
        make.top.mas_equalTo(lineV1.mas_bottom).offset(54);
        make.height.mas_equalTo(0.5);
    }];
    
    UILabel *titleLab2 = [[UILabel alloc] init];
    titleLab2.font = [UIFont systemFontOfSize:12.0];
    titleLab2.textColor = [UIColor colorWithHexString:@"#666666"];
    [self.maskV addSubview:titleLab2];
    [titleLab2 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.maskV).offset(15);
        make.top.mas_equalTo(lineV2.mas_bottom).offset(21);
    }];
    
    NSString *str=[NSString stringWithFormat:@"演出费（待支付）"];
    NSMutableAttributedString * attStr = [[NSMutableAttributedString alloc] initWithString:str];
    [attStr addAttributes:@{NSFontAttributeName:[UIFont systemFontOfSize:14.0]} range:NSMakeRange(0,3)];
    titleLab2.attributedText=attStr;
    
    UILabel *priceLab2 = [[UILabel alloc] init];
    priceLab2.font = [UIFont systemFontOfSize:14.0];
    priceLab2.textColor = [UIColor colorWithHexString:@"#666666"];
    [self.maskV addSubview:priceLab2];
    [priceLab2 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_equalTo(self.maskV).offset(-15);
        make.top.mas_equalTo(lineV2.mas_bottom).offset(21);
    }];
    
    NSInteger result ;
    if (type==0) {
        result = [total integerValue];
    }
    else
    {
        result = [total integerValue]-[model.price integerValue];
        if (result<=0) {
            result=0;
        }
    }
    priceLab2.text=[NSString stringWithFormat:@"¥%ld",result];

    UILabel *descLab = [[UILabel alloc] init];
    descLab.font = [UIFont systemFontOfSize:11.0];
    descLab.textColor = Public_Red_Color;
    [self.maskV addSubview:descLab];
    [descLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.maskV).offset(15);
        make.top.mas_equalTo(titleLab2.mas_bottom).offset(5);
    }];
    descLab.text=@"*最晚需在演出前一天支付。";
    
    UIView *lineV3=[[UIView alloc]init];
    lineV3.backgroundColor=[UIColor colorWithHexString:@"#F7F7F7"];
    [self.maskV addSubview:lineV3];
    [lineV3 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.maskV);
        make.right.mas_equalTo(self.maskV);
        make.top.mas_equalTo(lineV2.mas_bottom).offset(80);
        make.height.mas_equalTo(0.5);
    }];
    
    UILabel *titleLab3 = [[UILabel alloc] init];
    titleLab3.font = [UIFont systemFontOfSize:14.0];
    titleLab3.textColor = Public_Text_Color;
    [self.maskV addSubview:titleLab3];
    [titleLab3 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.maskV).offset(15);
        make.top.mas_equalTo(lineV3.mas_bottom).offset(21);
    }];
    titleLab3.text=@"演出费优惠";
    
    UILabel *priceLab3 = [[UILabel alloc] init];
    priceLab3.font = [UIFont systemFontOfSize:14.0];
    priceLab3.textColor = [UIColor colorWithHexString:@"#666666"];
    [self.maskV addSubview:priceLab3];
    [priceLab3 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_equalTo(self.maskV).offset(-15);
        make.centerY.mas_equalTo(titleLab3);
    }];
    priceLab3.text=[NSString stringWithFormat:@" - ¥%ld",sale<0?0:sale];
}

@end
