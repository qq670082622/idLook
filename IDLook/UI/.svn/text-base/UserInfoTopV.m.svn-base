//
//  UserInfoHeadV.m
//  IDLook
//
//  Created by HYH on 2018/5/10.
//  Copyright © 2018年 HYH. All rights reserved.
//

#import "UserInfoTopV.h"
#import "PublicPageControl.h"

@interface UserInfoTopV ()<UIScrollViewDelegate>
@property (nonatomic,strong)UIScrollView *scrollV;
@property (nonatomic,strong)PublicPageControl *pageControl;
@property (nonatomic,assign)NSInteger curPage;
@end

@implementation UserInfoTopV

-(id)initWithFrame:(CGRect)frame
{
    if (self=[super initWithFrame:frame]) {
        self.backgroundColor=[UIColor colorWithHexString:@"#F7F7F7"];
        
        [self scrollV];
        [self initUI];
        [self pageControl];
    }
    return self;
}

- (UIScrollView *)scrollV
{
    if(!_scrollV)
    {
        _scrollV = [[UIScrollView alloc] initWithFrame:CGRectMake(0, -SafeAreaTopHeight, UI_SCREEN_WIDTH,self.bounds.size.height-70+SafeAreaTopHeight)];
        _scrollV.pagingEnabled = YES;
        _scrollV.delegate = self;
        _scrollV.backgroundColor = [UIColor clearColor];
        _scrollV.showsHorizontalScrollIndicator = NO;
        _scrollV.showsVerticalScrollIndicator = NO;
        //        _scrollV.bounces=NO;
        _scrollV.contentSize = CGSizeMake(UI_SCREEN_WIDTH*3, 0);
        [self addSubview:_scrollV];
    }
    return _scrollV;
}

-(PublicPageControl*)pageControl
{
    if (!_pageControl) {
        _pageControl = [[PublicPageControl alloc] init];
        _pageControl.userInteractionEnabled = NO;
        _pageControl.hidesForSinglePage = YES;
        _pageControl.currentPageIndicatorTintColor = [UIColor whiteColor];
        _pageControl.pageIndicatorTintColor = [[UIColor whiteColor]colorWithAlphaComponent:0.5];
        _pageControl.currentPage=0;
        [self addSubview:_pageControl];
        [_pageControl mas_makeConstraints:^(MASConstraintMaker *make) {
            make.bottom.mas_equalTo(self).offset(-80);
            make.centerX.mas_equalTo(self);
        }];
    }
    return _pageControl;
}

-(void)initUI
{    
    UIView *shadowView = [[UIView alloc]init];
    shadowView.userInteractionEnabled=YES;
    [self addSubview:shadowView];
    shadowView.backgroundColor=[UIColor whiteColor];
    [shadowView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(self);
        make.left.mas_equalTo(self);
        make.bottom.mas_equalTo(self).offset(-10);
        make.height.mas_equalTo(@(90));
    }];

    UIImageView *icon = [[UIImageView alloc]init];
    [self addSubview:icon];
    icon.layer.cornerRadius=27.5;
    icon.layer.masksToBounds=YES;
    icon.tag=1000;
    icon.contentMode=UIViewContentModeScaleAspectFill;
    [icon mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerY.mas_equalTo(shadowView.mas_top);
        make.left.mas_equalTo(shadowView).offset(15);
        make.size.mas_equalTo(CGSizeMake(55, 55));
    }];

    UILabel *name = [[UILabel alloc]init];
    [self addSubview:name];
    name.font=[UIFont boldSystemFontOfSize:16.0];
    name.textColor=Public_Text_Color;
    name.tag=1001;
    [name mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(icon.mas_right).offset(13);
        make.top .mas_equalTo(shadowView).offset(15);
        if ([UserInfoManager getUserLoginType]==UserLoginTypeTourist || [UserInfoManager getUserAuthState]!=1) {
            make.width.mas_equalTo(UI_SCREEN_WIDTH-90-150);
        }
        else
        {
            make.width.mas_equalTo(UI_SCREEN_WIDTH-90-80);
        }
    }];
    
    UIView *performView=[[UIView alloc]init];
    [self addSubview:performView];
    performView.tag=1002;
    [performView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(icon.mas_right).offset(13);
        make.top .mas_equalTo(name.mas_bottom).offset(5);
        make.right.mas_equalTo(self).offset(-80);
        make.height.mas_equalTo(22);
    }];
    
    
    UILabel *weightLab = [[UILabel alloc]init];
    [self addSubview:weightLab];
    weightLab.font=[UIFont systemFontOfSize:13.0];
    weightLab.textColor=[UIColor colorWithHexString:@"#999999"];
    [weightLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(icon.mas_right).offset(13);
        make.top .mas_equalTo(performView.mas_bottom).offset(5);
    }];
    weightLab.tag=1003;
    
    UILabel *occupationlab = [[UILabel alloc]init];
    [self addSubview:occupationlab];
    occupationlab.textAlignment=NSTextAlignmentCenter;
    occupationlab.layer.masksToBounds=YES;
    occupationlab.layer.cornerRadius=9.0;
    occupationlab.font=[UIFont systemFontOfSize:10];
    occupationlab.textColor=[UIColor colorWithHexString:@"#FF2C54"];
    occupationlab.backgroundColor=[[UIColor colorWithHexString:@"#FF2C54"]colorWithAlphaComponent:0.1];
    occupationlab.tag=1004;
    [occupationlab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(icon.mas_centerX);
        make.top .mas_equalTo(icon.mas_bottom).offset(12);
        make.size.mas_equalTo(CGSizeMake(57, 18));
    }];
    
    
    UIButton *reginBtn=[UIButton buttonWithType:UIButtonTypeCustom];
    [self addSubview:reginBtn];
    [reginBtn setTitleColor:[UIColor colorWithHexString:@"#999999"] forState:UIControlStateNormal];
    reginBtn.titleLabel.font=[UIFont systemFontOfSize:13.0];
    [reginBtn setImage:[UIImage imageNamed:@"home_postion_gray"] forState:UIControlStateNormal];
    [reginBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(weightLab.mas_right).offset(5);
        make.centerY.mas_equalTo(weightLab);
    }];
    reginBtn.tag=1006;
    
    UIButton *sinaBtn=[UIButton buttonWithType:UIButtonTypeCustom];
    [self addSubview:sinaBtn];
    [sinaBtn setTitleColor:[UIColor colorWithHexString:@"#999999"] forState:UIControlStateNormal];
    sinaBtn.titleLabel.font=[UIFont systemFontOfSize:13.0];
    [sinaBtn setImage:[UIImage imageNamed:@"home_user_sina"] forState:UIControlStateNormal];
    [sinaBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(reginBtn.mas_right).offset(10);
        make.centerY.mas_equalTo(weightLab);
    }];
    sinaBtn.tag=1007;
    
    UIView *moreBG = [[UIView alloc]init];
    [self addSubview:moreBG];
    moreBG.backgroundColor=[UIColor clearColor];
    moreBG.userInteractionEnabled=YES;
    [moreBG mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(shadowView);
        make.centerY.mas_equalTo(shadowView);
        make.right.mas_equalTo(shadowView);
        make.width.mas_equalTo(72);
    }];
    
    UITapGestureRecognizer *tap =[[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(detialInfo)];
    [moreBG addGestureRecognizer:tap];

    UIView *lineV = [[UIView alloc]init];
    lineV.backgroundColor=Public_LineGray_Color;
    [self addSubview:lineV];
    [lineV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(shadowView).offset(15);
        make.centerY.mas_equalTo(shadowView);
        make.right.mas_equalTo(shadowView).offset(-72);
        make.width.mas_equalTo(0.5);
    }];
    
    UIImageView *moreIcon = [[UIImageView alloc]init];
    [self addSubview:moreIcon];
    moreIcon.image=[UIImage imageNamed:@"home_user_more"];
    [moreIcon mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(moreBG);
        make.bottom.mas_equalTo(shadowView.mas_centerY).offset(-3);
    }];
    
    UILabel *moreLab = [[UILabel alloc]init];
    [self addSubview:moreLab];
    moreLab.font=[UIFont systemFontOfSize:12.0];
    moreLab.textColor=Public_Text_Color;
    moreLab.text=@"更多";
    [moreLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(moreBG);
        make.top.mas_equalTo(shadowView.mas_centerY).offset(3);
    }];
    
    UIButton *lookPriceBtn=[UIButton buttonWithType:UIButtonTypeCustom];
    [self addSubview:lookPriceBtn];
    [lookPriceBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_equalTo(shadowView).offset(-82);
        make.centerY.mas_equalTo(name);
        make.size.mas_equalTo(CGSizeMake(80, 24));
    }];
    lookPriceBtn.tag=1008;
    lookPriceBtn.layer.cornerRadius=12;
    lookPriceBtn.layer.masksToBounds=YES;
    lookPriceBtn.layer.borderColor=[UIColor colorWithHexString:@"#EBEBEB"].CGColor;
    lookPriceBtn.layer.borderWidth=1.0;
    [lookPriceBtn setTitle:@"查看报价" forState:UIControlStateNormal];
    [lookPriceBtn setTitleColor:Public_Red_Color forState:UIControlStateNormal];
    lookPriceBtn.titleLabel.font=[UIFont systemFontOfSize:11.0];
    [lookPriceBtn addTarget:self action:@selector(lookPrice) forControlEvents:UIControlEventTouchUpInside];
    
    lookPriceBtn.imageEdgeInsets=UIEdgeInsetsMake(0,-3,0,3);
    if ([UserInfoManager getUserLoginType]==UserLoginTypeTourist || [UserInfoManager getUserAuthState]!=1) {
        [lookPriceBtn setImage:[UIImage imageNamed:@"home_lock"] forState:UIControlStateNormal];
        lookPriceBtn.titleEdgeInsets=UIEdgeInsetsMake(0, 3, 0, -3);
    }
    else
    {
        [lookPriceBtn setImage:[UIImage imageNamed:@""] forState:UIControlStateNormal];
    }

    UIButton *authBtn=[UIButton buttonWithType:UIButtonTypeCustom];
    [self addSubview:authBtn];
    [authBtn setImage:[UIImage imageNamed:@"home_auth"] forState:UIControlStateNormal];
    [authBtn setTitleColor:[UIColor colorWithHexString:@"#FF2C54"] forState:UIControlStateNormal];
    authBtn.titleLabel.font=[UIFont systemFontOfSize:12.0];
    [authBtn setTitle:@"已认证" forState:UIControlStateNormal];
    authBtn.tag=1005;
    
    [authBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(icon.mas_centerX);
        make.top.mas_equalTo(occupationlab.mas_bottom).offset(8);
    }];
    
    if ([UserInfoManager getUserType]==UserTypeResourcer)
    {
        lookPriceBtn.hidden=YES;
    }
    else
    {
        lookPriceBtn.hidden=NO;
    }
}

-(void)detialInfo
{
    self.UserInfoTopVDetialInfo();
}

//查看报价
-(void)lookPrice
{
    self.UserInfoTopVLookPrice();
}

-(void)reloadUIWithInfo:(UserInfoM *)info
{
    
    for (UIView *view in self.scrollV.subviews) {
        [view removeFromSuperview];
    }
    
    NSArray *array = @[[NSString stringWithFormat:@"%@",info.background.length>0?info.background:info.head]];
    self.scrollV.contentSize = CGSizeMake(UI_SCREEN_WIDTH*array.count, 0);
    for (int i=0; i<array.count; i++) {

        NSString *imageN =array[i];
        UIImageView *imageV=[[UIImageView alloc]initWithFrame:CGRectMake(self.bounds.size.width*i, 0,self.bounds.size.width, self.bounds.size.height-70+SafeAreaTopHeight)];
        [imageV sd_setImageWithUrlStr:imageN placeholderImage:[UIImage imageNamed:@"default_video"]];
        imageV.contentMode=UIViewContentModeScaleAspectFill;
        imageV.layer.masksToBounds=YES;
        imageV.userInteractionEnabled=YES;
        imageV.tag=i+100;
        [self.scrollV addSubview:imageV];
        UITapGestureRecognizer *tap=[[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(lookPhoto)];
        [imageV addGestureRecognizer:tap];
    }
    

    UIImageView *icon =[self viewWithTag:1000];
    UILabel *name = [self viewWithTag:1001];
    UIView *performView = [self viewWithTag:1002];
    UILabel *desc = [self viewWithTag:1003];
    UILabel *occupationlab = [self viewWithTag:1004];
    UIButton *authBtn =[self viewWithTag:1005];
    UIButton *reginBtn =[self viewWithTag:1006];
    UIButton *sinaBtn =[self viewWithTag:1007];

    
    [icon sd_setImageWithUrlStr:info.head placeholderImage:[UIImage imageNamed:@"default_icon"]];
    
    NSString *sex = @"";
    if (info.sex==1) {
        sex=@"/男";
    }
    else if (info.sex==2)
    {
        sex=@"/女";
    }
    else
    {
        sex=@"  ";
    }
    
    NSString *str=[NSString stringWithFormat:@"%@%@",info.nick.length>0?info.nick:info.name,sex];

    NSMutableAttributedString * attStr = [[NSMutableAttributedString alloc] initWithString:str];
    [attStr addAttributes:@{NSForegroundColorAttributeName:[UIColor colorWithHexString:@"#999999"],NSFontAttributeName:[UIFont systemFontOfSize:12.0]} range:NSMakeRange(str.length-2,2)];
    name.attributedText=attStr;
    
    if (info.performtype.length>0) {
        NSArray  *array = [info.performtype componentsSeparatedByString:@"|"];
        [performView mas_updateConstraints:^(MASConstraintMaker *make) {
            make.height.mas_equalTo(22);
        }];

        for (UIView *view in performView.subviews) {
            [view removeFromSuperview];
        }
        
        for (int i =0; i<array.count; i++) {
            if (i>=3) {
                break;
            }
            UIButton *btn=[UIButton buttonWithType:UIButtonTypeCustom];
            [performView addSubview:btn];
            [btn setBackgroundImage:[UIImage imageNamed:@"home_type"] forState:UIControlStateNormal];
            [btn setTitleColor:[UIColor colorWithHexString:@"#666666"] forState:UIControlStateNormal];
            btn.titleLabel.font=[UIFont systemFontOfSize:11.0];
            [btn setTitle:array[i] forState:UIControlStateNormal];
            [btn mas_makeConstraints:^(MASConstraintMaker *make) {
                make.left.mas_equalTo(performView).offset(50*i);
                make.centerY .mas_equalTo(performView);
            }];
        }
    }
    else
    {
        [performView mas_updateConstraints:^(MASConstraintMaker *make) {
            make.height.mas_equalTo(0);
        }];
    }
    
    desc.text=[NSString stringWithFormat:@"%ldcm · %ldkg ",info.height,info.weight];
    
    occupationlab.hidden =info.occupation>0?NO:YES;
    
    NSArray *array1 = [[UserInfoManager getPublicConfig] objectForKey:@"occupationType"];
    for (int i=0; i<array1.count; i++) {
        NSDictionary *dic = array1[i];
        if (info.occupation == [dic[@"attrid"] integerValue]) {
            occupationlab.text=dic[@"attrname"];
        }
    }
    
    authBtn.hidden = info.authentication==1?NO:YES;
    
    reginBtn.hidden=info.region.length>0?NO:YES;
    [reginBtn setTitle:info.region forState:UIControlStateNormal];
    
    sinaBtn.hidden = info.weiboFans>0?NO:YES;
    [sinaBtn setTitle:[NSString stringWithFormat:@"%@万",[PublicManager changeFloatWithFloat:info.weiboFans]] forState:UIControlStateNormal];

}

-(void)scrollViewDidScroll:(UIScrollView *)scrollView
{
    NSInteger curPage = (int)(scrollView.contentOffset.x)/(int)UI_SCREEN_WIDTH;
    self.curPage=curPage;
    
    self.pageControl.currentPage=self.curPage;
    
}

-(void)lookPhoto
{

}

-(void)changeImageFrameWithOffY:(CGFloat)offY
{
    self.scrollV.frame=CGRectMake(0,offY,self.bounds.size.width,self.bounds.size.height-70-offY);
    UIImageView *imageV=[self.scrollV viewWithTag:self.curPage+100];
    imageV.frame=CGRectMake(self.frame.size.width*self.curPage,0,self.frame.size.width, self.bounds.size.height-70-offY);
}

@end
