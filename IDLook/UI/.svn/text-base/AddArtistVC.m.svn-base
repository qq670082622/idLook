//
//  AddArtistVC.m
//  IDLook
//
//  Created by HYH on 2018/6/20.
//  Copyright © 2018年 HYH. All rights reserved.
//

#import "AddArtistVC.h"
#import "AddArtistCell.h"

static NSString *cellReuseIdentifer = @"cellReuseIdentifer";

@interface AddArtistVC ()<UICollectionViewDelegate,UICollectionViewDataSource,CustomCollectViewDelegate>
@property(nonatomic,strong)CustomCollectV *collectionView;
@property(nonatomic,strong)NSMutableArray *dataSource;
@property(nonatomic,strong)UIButton *addBtn;
@property(nonatomic,strong)NSMutableArray *selectArray;

@end

@implementation AddArtistVC

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    self.view.backgroundColor=Public_Background_Color;
    
    [self.navigationItem setTitleView:[CustomNavVC setDefaultNavgationItemTitle:@"添加其他艺人"]];
    
    [self.navigationItem setLeftBarButtonItem:[[UIBarButtonItem alloc] initWithCustomView:[CustomNavVC getLeftDefaultButtonWithTarget:self action:@selector(onGoback)]]];
    self.dataSource=[[NSMutableArray alloc]initWithCapacity:0];
    self.selectArray = [[NSMutableArray alloc]initWithArray:self.checkedArray];
    
    [self refreshDataWithSortKey:0];

    [self collectionView];
    
    [self addBtn];
}

-(void)onGoback
{
    [self.navigationController popViewControllerAnimated:YES];
}

-(void)refreshDataWithSortKey:(NSInteger)sortkey
{
    [self.collectionView startLoading];
    NSDictionary *dicArg = @{@"userid":[UserInfoManager getUserUID],
                             @"sortkey":@(sortkey),
                             @"pagenumber":@"30"};
    
    [AFWebAPI getCollectionListWithArg:dicArg callBack:^(BOOL success, id object) {
        if (success) {
            [SVProgressHUD dismiss];
            
            NSArray *array = [object objectForKey:JSON_data];
            for (int i = 0; i<array.count; i++) {
                UserInfoM *info = [[UserInfoM alloc]initWithDic:array[i]];
                
                UserInfoM *info2=[self.checkedArray firstObject];
                if (![info.UID isEqualToString:info2.UID]) {
                    [self.dataSource addObject:info];
                }

            }
            
            //收藏艺人列表中，是否已选中
            for (int i =0; i<self.dataSource.count; i++) {
                UserInfoM *info1=self.dataSource[i];
                
                for (int j =0; j<self.checkedArray.count;j++) {
                    UserInfoM *info2=self.checkedArray[j];
                    if ([info1.UID isEqualToString:info2.UID]) {
                        info1.isChoose=YES;
                    }
                }
            }
            
            [self.collectionView reloadData];
            [self.collectionView hideNoDataScene];
            if (self.dataSource.count==0) {
                [self.collectionView showWithNoDataType:NoDataTypeCollection];
            }
        }
        else
        {
            [self.collectionView hideNoDataScene];
            [self.collectionView showWithNoDataType:NoDataTypeNetwork];
        }
    }];
}

-(CustomCollectV*)collectionView
{
    if (!_collectionView) {
        UICollectionViewFlowLayout *flowLayout=[[UICollectionViewFlowLayout alloc] init];
        flowLayout.minimumLineSpacing = 15;
        flowLayout.minimumInteritemSpacing = 15;
        [flowLayout setSectionInset:UIEdgeInsetsMake(15, 15, 15,15)];
        
        [flowLayout setScrollDirection:UICollectionViewScrollDirectionVertical];
        _collectionView = [[CustomCollectV alloc] initWithFrame:CGRectMake(0,0,UI_SCREEN_WIDTH,UI_SCREEN_HEIGHT-SafeAreaTopHeight-48) collectionViewLayout:flowLayout];
        _collectionView.dataSource=self;
        _collectionView.delegate=self;
        _collectionView.dele=self;
        _collectionView.scrollEnabled=YES;
        _collectionView.showsHorizontalScrollIndicator=NO;
        [_collectionView setBackgroundColor:[UIColor clearColor]];
        [_collectionView registerClass:[AddArtistCell class] forCellWithReuseIdentifier:cellReuseIdentifer];
        
        [self.view addSubview:_collectionView];
    }
    return _collectionView;
}

-(UIButton*)addBtn
{
    if (!_addBtn) {
        _addBtn=[UIButton buttonWithType:UIButtonTypeCustom];
        [self.view addSubview:_addBtn];
        [_addBtn setBackgroundImage:[UIImage imageNamed:@"order_confirm_add"] forState:UIControlStateNormal];
        [_addBtn setBackgroundImage:[UIImage imageNamed:@"order_confirm_add"] forState:UIControlStateSelected];
        [_addBtn setTitle:@"确认添加" forState:UIControlStateNormal];
        [_addBtn setTitleColor:[UIColor colorWithHexString:@"#FBFBFB"] forState:UIControlStateNormal];
        [_addBtn mas_makeConstraints:^(MASConstraintMaker *make) {
            make.bottom.mas_equalTo(self.view);
            make.right.mas_equalTo(self.view);
            make.left.mas_equalTo(self.view);
            make.height.mas_equalTo(48);
        }];
        [_addBtn addTarget:self action:@selector(addAction) forControlEvents:UIControlEventTouchUpInside];
    }
    return _addBtn;
}

//确认添加
-(void)addAction
{
    if (self.selectArray.count==0) {
        [SVProgressHUD showErrorWithStatus:@"请选择要添加的艺人"];
        return;
    }
    
    self.addArtistWithArray(self.selectArray);
    [self onGoback];
}

#pragma mark -
#pragma mark - UICollectionViewDataSource

- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section
{
    return self.dataSource.count;
}

- (NSInteger)numberOfSectionsInCollectionView:(UICollectionView *)collectionView
{
    return 1;
}

- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath
{
    AddArtistCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:cellReuseIdentifer forIndexPath:indexPath];
    cell.backgroundColor=[UIColor colorWithHexString:@"#FBFBFB"];
    UserInfoM *info = self.dataSource[indexPath.row];
    [cell reloadUIWithInfo:info];
    return cell;
}

#pragma mark -
#pragma mark -UICollectionViewDelegateFlowLayout

- (CGSize)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout*)collectionViewLayout sizeForItemAtIndexPath:(NSIndexPath *)indexPath
{
    return CGSizeMake(AddArtistCellWidth, AddArtistCellWidth*(360.0/330.0));
}

- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(nonnull NSIndexPath *)indexPath
{
    UserInfoM *info = self.dataSource[indexPath.row];
    info.isChoose = !info.isChoose;
    [self.collectionView reloadItemsAtIndexPaths:[NSArray arrayWithObjects:indexPath, nil]];
    
    
    if (info.isChoose==YES) {
        [self.selectArray addObject:info];
    }
    else
    {
        for (int i = 0; i<self.selectArray.count; i++) {
            UserInfoM *info1= self.selectArray[i];
            if ([info.UID isEqualToString:info1.UID]) {
                [self.selectArray removeObject:info1];
            }
        }
    }
}
#pragma mark---
#pragma mark---CustomCollectViewDelegate
-(void)CustomCollectViewNoDataSceneClicked:(id)sender
{
    
}

@end
