//
//  AuditionStep1.m
//  IDLook
//
//  Created by HYH on 2018/6/19.
//  Copyright © 2018年 HYH. All rights reserved.
//

#import "AuditionStep1.h"
#import "PlaceOrderCustomCell.h"
#import "PlaceOrderHeadV.h"
#import "PlaceOrderFootV.h"
#import "PlaceAuditCellA.h"
#import "PlaceAuditCellB.h"
#import "AuditionStep2.h"
#import "AddArtistVC.h"
#import "OrderPickerPopV.h"
#import "CitySelectStep1.h"
#import "BirthSelectV.h"

@interface AuditionStep1 ()<UITableViewDelegate,UITableViewDataSource,TableVTouchDelegate,PlaceAuditCellADelegate>
@property(nonatomic,strong)TouchTableV *tableV;
@property(nonatomic,strong)NSMutableArray *dataSource;
@property(nonatomic,strong)NSIndexPath *indexPath;
@end

@implementation AuditionStep1

-(void)dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self
                                                    name:UIKeyboardWillChangeFrameNotification
                                                  object:nil];
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    self.view.backgroundColor=Public_Background_Color;
    
    [self.navigationItem setTitleView:[CustomNavVC setDefaultNavgationItemTitle:@"试镜下单"]];
    
    [self.navigationItem setLeftBarButtonItem:[[UIBarButtonItem alloc] initWithCustomView:[CustomNavVC getLeftDefaultButtonWithTarget:self action:@selector(onGoback)]]];
    
    
    [self getData];
    
    [self tableV];
    
    [[NSNotificationCenter defaultCenter] addObserver:self
                                             selector:@selector(keyboardFrameWillChange:)
                                                 name:UIKeyboardWillChangeFrameNotification
                                               object:nil];
}

-(void)onGoback
{
    [self.navigationController popViewControllerAnimated:YES];
}

-(void)getData
{
    self.dataSource =[[NSMutableArray alloc]initWithCapacity:0];

    [self.dataSource addObject:@[self.info]];
    [self.dataSource addObject:[PlaceOrderModel getAuditionWay]];
    [self.dataSource addObject: [PlaceOrderModel getAuditionRequirement]];
    
    if (self.model==nil) {
        return;
    }
    
    {
        OrderStructM *model1 = self.dataSource[1][0];
        OrderStructM *model2 = self.dataSource[1][1];

        if (self.model.auditionType==0) {
            model1.isChoose=NO;
            model2.isChoose=YES;
        }
        else if(self.model.auditionType==2)
        {
            model1.isChoose=YES;
            model2.isChoose=NO;
        }
    }
    
    {
        OrderStructM *model1 = self.dataSource[2][0];
        OrderStructM *model2 = self.dataSource[2][1];
        OrderStructM *model3 = self.dataSource[2][2];
        
        OrderStructM *model4 = self.dataSource[2][3];
        OrderStructM *model5 = self.dataSource[2][4];
        OrderStructM *model6 = self.dataSource[2][5];
        OrderStructM *model7 = self.dataSource[2][6];
        
        model1.content=self.model.projectName;
        model2.content=self.model.brand;
        model3.content=self.model.product;
        
        model5.content=self.model.shootplace;
        model6.content=self.model.shoottime;
        model7.content=self.model.datereservation;
        
        NSArray *dayArr=[PublicManager getOrderCellType:OrderCheckTypeDays];
        for (int i=0; i<dayArr.count; i++) {
            NSString *str= dayArr[i];
            if (str.length==2) {
                NSString *strss=[str substringToIndex:1];
                if (self.model.shootdays==[strss integerValue]) {
                    model4.content=str;
                }
            }
            else
            {
                if (self.model.shootdays==6) {
                     model4.content=str;
                }
            }
        }
    }
}

-(TouchTableV*)tableV
{
    if (!_tableV) {
        _tableV = [[TouchTableV alloc] initWithFrame:CGRectMake(0,0,UI_SCREEN_WIDTH,UI_SCREEN_HEIGHT-SafeAreaTabBarHeight_IphoneX) style:UITableViewStyleGrouped];
        _tableV.delegate = self;
        _tableV.dataSource = self;
        _tableV.touchDelegate=self;
        _tableV.showsVerticalScrollIndicator=NO;
        _tableV.showsHorizontalScrollIndicator=NO;
        _tableV.separatorStyle=UITableViewCellSeparatorStyleNone;
        _tableV.autoresizingMask = UIViewAutoresizingFlexibleHeight;
        [self.view addSubview:_tableV];
        _tableV.estimatedRowHeight = 0;
        _tableV.estimatedSectionHeaderHeight = 0;
        _tableV.estimatedSectionFooterHeight = 0;
        _tableV.backgroundColor=[UIColor clearColor];
    }
    return _tableV;
}

#pragma mark -
#pragma mark - UITableViewDataSource&&UITableViewDelegate

- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section
{
    if (section==2) {
        return 120;
    }
    return .1f;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
{
    if (section==0) {
        return 40.f;
    }
    return 50.f;
}

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView
{
    return self.dataSource.count;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    if (section==0) {
        return 1;
    }
    return [self.dataSource[section]count];
}

-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (indexPath.section==0) {
        return 115;
    }
    else if (indexPath.section==1)
    {
        return 88;
    }
    return 48;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (indexPath.section==0) {
        static NSString *identifer = @"PlaceAuditCellA";
        PlaceAuditCellA *cell = [tableView dequeueReusableCellWithIdentifier:identifer];
        if(!cell)
        {
            cell = [[PlaceAuditCellA alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:identifer];
            cell.selectionStyle = UITableViewCellSelectionStyleNone;
            cell.backgroundColor=[UIColor whiteColor];
            cell.delegate=self;
        }
        [cell reloadUIWithArray:self.dataSource[indexPath.section]];
        return cell;
    }
    else if (indexPath.section==1)
    {
        static NSString *identifer = @"PlaceAuditCellB";
        PlaceAuditCellB *cell = [tableView dequeueReusableCellWithIdentifier:identifer];
        if(!cell)
        {
            cell = [[PlaceAuditCellB alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:identifer];
            cell.selectionStyle = UITableViewCellSelectionStyleNone;
            cell.backgroundColor=[UIColor whiteColor];
        }
        [cell reloadUIWithModel:self.dataSource[indexPath.section][indexPath.row]];
        return cell;
    }
    else if(indexPath.section==2)
    {
        static NSString *identifer = @"PlaceOrderCustomCell";
        PlaceOrderCustomCell *cell = [tableView dequeueReusableCellWithIdentifier:identifer];
        if(!cell)
        {
            cell = [[PlaceOrderCustomCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:identifer];
            cell.selectionStyle = UITableViewCellSelectionStyleNone;
            cell.backgroundColor=[UIColor whiteColor];
        }
        [cell reloadUIWithModel:self.dataSource[indexPath.section][indexPath.row]];
        WeakSelf(self);
        cell.BeginEdit = ^{
            weakself.indexPath=indexPath;
        };
        return cell;
    }
    return nil;
}

-(UIView*)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section
{
    static NSString *identifer = @"PlaceOrderHeadV";
    PlaceOrderHeadV *headerView = [tableView dequeueReusableHeaderFooterViewWithIdentifier:identifer];
    if(!headerView)
    {
        headerView = [[PlaceOrderHeadV alloc] initWithReuseIdentifier:identifer];
        [headerView.backgroundView setBackgroundColor:[UIColor clearColor]];
    }
    NSString *title=@"";
    if (section==0) {
        title = @"试镜艺人";
    }
    else if (section==1)
    {
        title = @"试镜方式";
    }
    else if (section==2)
    {
        title = @"任务及要求";
    }
    [headerView reloadUIWithTitle:title];
    return headerView;
}

-(UIView*)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section
{
    if (section==2) {
        static NSString *identifer = @"PlaceOrderFootV";
        PlaceOrderFootV *footerView = [tableView dequeueReusableHeaderFooterViewWithIdentifier:identifer];
        if(!footerView)
        {
            footerView = [[PlaceOrderFootV alloc] initWithReuseIdentifier:identifer];
            [footerView.backgroundView setBackgroundColor:[UIColor clearColor]];
            WeakSelf(self);
            footerView.nextStep = ^{
                [weakself nextStep];
            };
        }
        [footerView reloadUIWithTitle:@"下一步"];
        return footerView;
    }
    return nil;
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
//    [tableView deselectRowAtIndexPath:indexPath animated:YES];

    if (indexPath.section==1) {   //试镜方式
        
        for (int i =0;i<[self.dataSource[indexPath.section] count]; i++) {
            OrderStructM *model = self.dataSource[indexPath.section][i];
            model.isChoose=NO;
        }
        
        OrderStructM *model = self.dataSource[indexPath.section][indexPath.row];
        model.isChoose=!model.isChoose;
        
        [self.tableV reloadSections:[NSIndexSet indexSetWithIndex:indexPath.section] withRowAnimation:UITableViewRowAnimationAutomatic];
    }
    else if (indexPath.section==2)
    {
        OrderStructM *model = self.dataSource[indexPath.section][indexPath.row] ;

        if (indexPath.row==3) {    //拍摄天数
            OrderPickerPopV *pickerV = [[OrderPickerPopV alloc] init];
            pickerV.title=model.title;
            pickerV.didSelectBlock = ^(NSString *select,NSInteger type) {
                model.content=select;
                [tableView reloadRowsAtIndexPaths:[NSArray arrayWithObjects:indexPath, nil] withRowAnimation:UITableViewRowAnimationAutomatic];
            };
            
            [pickerV showWithPickerType:OrderCheckTypeDays withDesc:model.content];
        }
        else if (indexPath.row==4)  //拍摄地点
        {
            NSArray  *array = [NSArray array];  //选中的传人
            if (model.content.length) {
                array=[model.content componentsSeparatedByString:@"、"];
            }
            
            CitySelectStep1 *step1 = [[CitySelectStep1 alloc]init];
            step1.artistRegin=self.info.region;
            step1.selectedArr=array;
            step1.selectCity = ^(NSString *city) {
                model.content=city;
                [tableView reloadRowsAtIndexPaths:[NSArray arrayWithObjects:indexPath, nil] withRowAnimation:UITableViewRowAnimationAutomatic];
            };
            [self.navigationController pushViewController:step1 animated:YES];
        }
        else if (indexPath.row==5 || indexPath.row==6)  //拍摄时间，预约试镜时间
        {
            BirthSelectV *birthV = [[BirthSelectV alloc] init];
            birthV.didSelectDate = ^(NSString *dateStr){
                model.content=dateStr;
                [tableView reloadRowsAtIndexPaths:[NSArray arrayWithObjects:indexPath, nil] withRowAnimation:UITableViewRowAnimationAutomatic];
            };
            [birthV showWithString:model.content withType:DateTypeDay];
        }
    }
}

-(void)scrollViewDidScroll:(UIScrollView *)scrollView
{
//    [self.view endEditing:YES];
}

#pragma mark -
#pragma mark - TableVTouchDelegate
- (void)tableView:(UITableView *)tableView touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event
{
    [self.view endEditing:YES];
}

-(void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    [self.view endEditing:YES];
}

#pragma mark---
#pragma mark---PlaceAuditCellADelegate
//添加艺人
-(void)addArtist
{
    AddArtistVC *addVC=[[AddArtistVC alloc]init];
    addVC.checkedArray = [self.dataSource firstObject];
    WeakSelf(self);
    addVC.addArtistWithArray = ^(NSArray *array) {
        NSMutableArray *dataS = [[NSMutableArray alloc]initWithCapacity:0];
        for (int i = 0 ; i<array.count; i++) {
            UserInfoM *info = array[i];
            [dataS addObject:info];
        }
        [weakself.dataSource replaceObjectAtIndex:0 withObject:dataS];
        [weakself.tableV reloadSections:[NSIndexSet indexSetWithIndex:0] withRowAnimation:UITableViewRowAnimationAutomatic];
    };
    [self.navigationController pushViewController:addVC animated:YES];
}

//删除艺人
-(void)delectArtistWithIndex:(NSInteger)index
{
    NSMutableArray *dataS = [[NSMutableArray alloc]initWithArray:[self.dataSource firstObject]];
    if (index<dataS.count) {
        [dataS removeObjectAtIndex:index];
        [self.dataSource replaceObjectAtIndex:0 withObject:dataS];
        [self.tableV reloadSections:[NSIndexSet indexSetWithIndex:0] withRowAnimation:UITableViewRowAnimationNone];
    }
}

#pragma mark---
#pragma 下一步
-(void)nextStep
{
    
    NSInteger auditionWay=-1;
    NSString *price = @"";
    for (int i =0;i<[self.dataSource[1] count]; i++)
    {
        OrderStructM *model = self.dataSource[1][i];
        if (model.isChoose)
        {
            if (i==0) {
                auditionWay=2;
            }
            else if (i==1)
            {
                auditionWay=0;
            }
            price=model.price;
        }
    }
    
    if (auditionWay<0) {
        [SVProgressHUD showErrorWithStatus:@"请选择试镜方式！"];
        return;
    }
    
    for (int i =0;i<[self.dataSource[2] count]-1; i++)
    {
        OrderStructM *model =  self.dataSource[2][i];
        if (model.content.length==0) {
            [SVProgressHUD showErrorWithStatus:@"请将任务要求信息填写完整！"];
            return;
        }
    }
    
    OrderStructM *model1 = self.dataSource[2][0];
    OrderStructM *model2 = self.dataSource[2][1];
    OrderStructM *model3 = self.dataSource[2][2];
    
    OrderStructM *model4 = self.dataSource[2][3];
    OrderStructM *model5 = self.dataSource[2][4];
    OrderStructM *model6 = self.dataSource[2][5];
    OrderStructM *model7 = self.dataSource[2][6];
    
    NSMutableArray *array = [NSMutableArray new];
    for (int i=0;i<[self.dataSource[0]count]; i++) {
        UserInfoM *info =self.dataSource[0][i];
        [array addObject:info.UID];
    }
    
    NSInteger shotDay=0;
    if (model4.content.length==2) {
        NSString *strss=[model4.content substringToIndex:1];
        shotDay=[strss integerValue];
    }
    else
    {
        shotDay=6;
    }
    
    NSString *tempString = [array componentsJoinedByString:@","];//分隔符逗号
    NSDictionary *dic = @{@"userid":[UserInfoManager getUserUID],
                          @"artistid":tempString,
                          @"auditiontype":@(auditionWay),
                          @"entryname":model1.content,
                          @"brand":model2.content,
                          @"product":model3.content,
                          @"shootdays":@(shotDay),
                          @"shootplace":model5.content,
                          @"shoottime":model6.content,
                          @"datereservation":[NSString stringWithFormat:@"%@",model7.content],
                          @"price":price,
                          @"totalprice":price};
    
    AuditionStep2 *step2=[[AuditionStep2 alloc]init];
    step2.dic=dic;
    step2.model=self.model;
    [self.navigationController pushViewController:step2 animated:YES];
}

#pragma mark--keyboard Noti
- (void)keyboardFrameWillChange:(NSNotification*)notification
{
    CGRect rect = [notification.userInfo[UIKeyboardFrameEndUserInfoKey] CGRectValue];
    
//    NSLog(@"--%f --%f --%f --%f",rect.origin.x,rect.origin.y,rect.size.width,rect.size.height);
    
    //当前Cell在屏幕中的坐标值
    CGRect rectInTableView = [self.tableV rectForRowAtIndexPath:self.indexPath];
    CGRect cellRect = [self.tableV convertRect:rectInTableView toView:[self.tableV superview]];
    
    if (rect.origin.y-120-cellRect.origin.y<0) {
        [self.tableV setContentOffset:CGPointMake(0,-rect.origin.y+cellRect.origin.y+120+self.tableV.contentOffset.y) animated:YES];
    }
//     NSLog(@"indexPath--%f --%f --%f --%f",cellRect.origin.x,cellRect.origin.y,cellRect.size.width,cellRect.size.height);
}

@end
