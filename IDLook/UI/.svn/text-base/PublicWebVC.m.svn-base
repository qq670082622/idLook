//
//  PublicWebVC.m
//  IDLook
//
//  Created by HYH on 2018/7/31.
//  Copyright © 2018年 HYH. All rights reserved.
//

#import "PublicWebVC.h"

@interface PublicWebVC ()<UIWebViewDelegate>
{
    int _LinkCount;
    UIWebView * _webView;
}
@property (nonatomic,retain) NSString * navTitle;
@property (nonatomic,retain) NSString * url;
@end

@implementation PublicWebVC

- (id)initWithTitle:(NSString *)title
                url:(NSString *)url
{
    self = [super init];
    if(self)
    {
        self.navTitle=title;
        self.url=url;
        self.hideNavBar=NO;
        _LinkCount=0;
        
        [self processLinkUrl];
    }
    return self;
}

- (void)processLinkUrl
{
    if([self.url rangeOfString:@"user_protocol"].length)
    {
        return;
    }
    
    NSString *lowUrl = [self.url lowercaseString];
    
    NSRange range = [lowUrl rangeOfString:@"http://"];
    if(range.length<7)
    {
        self.url = [NSString stringWithFormat:@"http://%@",self.url];
    }
}

- (BOOL)webView:(UIWebView*)webView shouldStartLoadWithRequest:(NSURLRequest*)request navigationType:(UIWebViewNavigationType)navigationType
{
    NSURL *url = [request URL];
    NSString *str=[url absoluteString];
    
    if (navigationType == UIWebViewNavigationTypeLinkClicked)
    {
        
        NSString *tag=[str substringToIndex:7];
        
        if ([tag isEqualToString:@"userid:"])
        {
            
            return NO;
        }
        
        _LinkCount++;
        
    }
    return TRUE;
}



- (void)viewDidLoad {
    [super viewDidLoad];
    
//    if(self.hideNavBar)
//        [self.navigationController setNavigationBarHidden:YES animated:YES];
    [self.navigationItem setTitleView:[CustomNavVC setDefaultNavgationItemTitle:self.navTitle]];
    [self.navigationItem setLeftBarButtonItem:[[UIBarButtonItem alloc] initWithCustomView:[CustomNavVC getLeftDefaultButtonWithTarget:self action:@selector(onGoBack)]]];
    
    [self.navigationItem setRightBarButtonItem:[[UIBarButtonItem alloc]initWithCustomView:[CustomNavVC getRightBarButtonItem2WithTarget:self action:@selector(onFinish) normalImg:@"icon_close" hilightImg:@"icon_close"]]];
    
    [self.view setBackgroundColor:Public_Background_Color];
    
    UIWebView* webView = [[UIWebView alloc]initWithFrame:self.view.bounds];
    webView.delegate=self;
    webView.scalesPageToFit = YES;
    webView.autoresizesSubviews = NO;
    webView.autoresizingMask=(UIViewAutoresizingFlexibleHeight | UIViewAutoresizingFlexibleWidth);
    [self.view addSubview:webView];
    
    NSURL* url = [NSURL URLWithString:_url];
    NSURLRequest* request = [NSURLRequest requestWithURL:url];
    [webView loadRequest:request];
    _webView=webView;
}

- (void)viewWillDisappear:(BOOL)animated {
    [super viewWillDisappear:animated];
    
//    if(self.hideNavBar)
//        [self.navigationController setNavigationBarHidden:NO animated:YES];
}

- (void) onGoBack
{
    if (self.presentingViewController)
    {
        [self dismissViewControllerAnimated:YES completion:nil];
        return;
    }
    
    if(_LinkCount<=0)
    {
        [self.navigationController popViewControllerAnimated:YES];
    }
    else {
        _LinkCount--;
        if( [_webView canGoBack] )
            [_webView goBack];
        else
            [self.navigationController popViewControllerAnimated:YES];
    }
}

- (void)onFinish
{
    if (self.presentingViewController)
    {
        [self dismissViewControllerAnimated:YES completion:nil];
        return;
    }
    [self.navigationController popViewControllerAnimated:YES];
}

@end
